---

# Role tests

- hosts: 'all'
  remote_user: "{{ lookup('env', 'VAGRANT') == 'true' | ternary('vagrant', 'root') }}"
  pre_tasks:
    - name: 'Create test application user'
      become: True
      user:
        name: 'foobar'
      changed_when: False
    - name: 'Install test system dependencies'
      become: True
      apt:
        name: "{{ item }}"
        state: 'present'
      with_items:
        - 'curl'
        - 'nginx'
        - 'python-dev'
        - 'python-pip'
        - 'sudo'
      changed_when: False
    - name: 'Install virtualenv'
      become: True
      pip:
        name: 'virtualenv'
      changed_when: False
    - name: 'Create test application folders'
      become: True
      become_user: 'foobar'
      file:
        dest: "{{ item }}"
        state: 'directory'
      with_items:
        - '/home/foobar/app'
        - '/home/foobar/venv'
      changed_when: False
    - name: 'Copy test application files'
      become: True
      become_user: 'foobar'
      copy:
        src: "{{ item }}"
        dest: '/home/foobar/app'
      with_items:
        - 'requirements.txt'
        - 'foo.py'
      changed_when: False
    - name: 'Install test python dependencies'
      become: True
      become_user: 'foobar'
      pip:
        requirements: '/home/foobar/app/requirements.txt'
        virtualenv: '/home/foobar/venv'
      changed_when: False
    - name: 'Copy Nginx configuration file'
      become: True
      copy:
        src: 'nginx.conf'
        dest: '/etc/nginx/sites-enabled/foo.conf'
      changed_when: False
    - name: 'Remove Nginx default configuration'
      become: True
      file:
        path: '/etc/nginx/sites-enabled/default'
        state: 'absent'
      changed_when: False
    - name: 'Restart Nginx'
      become: True
      service:
        name: 'nginx'
        state: 'restarted'
      changed_when: False
  roles:
    - role: "{{ role_name }}"
  vars:
    role_name: "{{ playbook_dir | basename }}"
  vars_files:
    - './tests/test_vars.yml'
